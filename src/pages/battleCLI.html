<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="JU-DO-KON! Classic Battle – CLI mode" />
    <title>JU-DO-KON! – Classic Battle CLI</title>
    <link rel="stylesheet" href="../styles/cli-immersive.css" />
    <link rel="stylesheet" href="../styles/components.css" />
    <style>
      :root {
        color-scheme: light dark;
      }
      html,
      body {
        height: 100%;
        margin: 0;
      }
      body {
        font-family:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
          monospace;
        background: #0b0c0c;
        color: #f2f2f2;
        line-height: 1.45; /* Enhanced readability for monospace */
        font-size: 14px; /* Consistent base size */
      }
      .cli-root {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
      }
      .cli-root > * {
        max-width: 100%;
      }
      .cli-header {
        padding: 12px 16px; /* Increased for better touch targets */
        border-bottom: 1px solid #3a3a3a;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-width: 18ch; /* reserve width for longest state (prevents wrap/jump) */
        box-sizing: border-box; /* include padding in fixed height */
        height: 64px; /* Slightly increased for better proportions */
        position: relative; /* allow absolute-centering children like #cli-round */
        background: #0d0d0d; /* Subtle background variation */
      }
      .cli-title {
        font-weight: 600; /* Slightly reduced for cleaner look */
        font-size: 15px;
        color: #ffffff; /* Enhanced contrast */
      }
      /* Enhanced countdown styling with terminal aesthetics */
      #cli-countdown {
        min-height: 1.2em !important; /* Force em units for PRD compliance */
        font-weight: 600;
        color: #ffcc00; /* Warning color for timer */
      }
      #cli-countdown:before {
        content: "⏱ "; /* Timer icon for visual clarity */
        opacity: 0.8;
      }
      .state-badge {
        font-size: 12px;
        opacity: 0.8;
        margin-left: 8px;
        /* Reserve vertical space for stat rows to avoid layout shift when populated */
        min-height: 8rem;
      }
      .cli-stat {
        padding: 4px 6px;
        background: #121212;
        border: 1px solid #3a3a3a;
        min-height: 2.4em;
        display: flex;
        align-items: center;
        gap: 8px;
        align-items: center;
      }
      .cli-main {
        flex: 1;
        display: flex;
        width: 100%;
        max-width: 100%;
        margin: 0;
        flex-direction: column;
        padding: 16px 20px; /* Consistent 8px rhythm */
        gap: 16px; /* 8px rhythm maintained */
      }
      .cli-main > * {
        max-width: 100%;
      }
      /* Retro theme: green-on-black optional class and global retro theme */
      body.cli-retro,
      body[data-theme="retro"] {
        background: #000 !important;
        color: #8cff6b !important;
      }
      body.cli-retro a,
      body[data-theme="retro"] a {
        color: #8cff6b;
      }
      body.cli-retro .cli-stat,
      body.cli-retro .cli-block,
      body[data-theme="retro"] .cli-stat,
      body[data-theme="retro"] .cli-block {
        background: #000;
        color: #8cff6b;
        border-color: #8cff6b;
      }
      body.cli-retro .cli-stat.selected,
      body[data-theme="retro"] .cli-stat.selected {
        background: #001900;
        border-color: #8cff6b;
      }
      .cli-block {
        padding: 12px 16px; /* Consistent 8px rhythm */
        border: 1px solid #333;
        background: #0f0f0f;
        border-radius: 4px; /* Subtle rounding */
        margin-bottom: 4px; /* Better section separation */
      }
      .cli-settings {
        background: #0d0d0d;
        color: #cfcfcf;
        font-size: 13px;
      }
      .cli-settings:not([hidden]) {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .cli-settings[hidden] {
        display: none;
      }
      .cli-settings-row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      /* Terminal-style separators with enhanced visual hierarchy */
      .ascii-sep {
        font-family: inherit;
        color: #4a4a4a; /* Subtle separator color */
        padding: 8px 0;
        text-align: center;
        font-size: 12px;
        letter-spacing: 2px; /* Spaced out for visual effect */
        opacity: 0.7;
      }
      /* Enhanced round message styling */
      #round-message {
        min-height: 1.4em !important; /* Force em units */
        font-weight: 500;
        color: #ffffff; /* Enhanced contrast for important messages */
      }
      #round-message:not(:empty):before {
        content: "→ "; /* Arrow indicator for results */
        opacity: 0.8;
        color: #9ad1ff;
      }
      /* Add prompt indicator for stat selection */
      .cli-block[aria-label="Stat Selection"]:before {
        content: "→ Choose your stat:";
        display: block;
        color: #9ad1ff;
        font-weight: 500;
        margin-bottom: 8px;
        opacity: 0.9;
      }
      /* Make verbose section scrollable so newest entries are visible */
      #cli-verbose-log {
        max-height: 35vh;
        overflow-y: auto;
      }
      #cli-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 8px;
        min-height: 8rem; /* Reserve space for layout stability and touch targets */
      }
      .cli-stat {
        padding: 8px 12px; /* Enhanced padding for better touch targets */
        background: #121212;
        border: 1px solid #3a3a3a;
        min-height: 44px; /* PRD requirement: touch targets ≥44px */
        display: flex;
        align-items: center;
        justify-content: space-between; /* Better alignment for terminal look */
        font-family: inherit;
        font-size: 14px;
        border-radius: 3px; /* Subtle rounding for modern feel */
        transition: background-color 0.15s ease; /* Smooth hover feedback */
      }
      .cli-stat.skeleton {
        opacity: 0.5;
        color: #666;
        font-style: italic; /* Subtle indicator for placeholder state */
      }
      .cli-stat.selected {
        border-color: #9ad1ff;
        background: #1a1a1a;
        box-shadow: 0 0 0 1px #9ad1ff33; /* Subtle glow effect */
      }
      .cli-stat:hover {
        background: #181818; /* Subtle hover feedback */
        border-color: #4a4a4a;
      }
      /* High-contrast focus state for stat rows */
      .cli-stat:focus {
        background: #103a56; /* dark navy to ensure strong text contrast */
        border-color: #9ad1ff;
        outline: 2px solid #9ad1ff;
        outline-offset: 2px;
        box-shadow:
          0 0 0 2px #0b0c0c,
          0 0 0 4px #9ad1ff;
      }
      .cli-controls {
        /* make controls lay out horizontally and center-aligned */
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .cli-status {
        /* keep the status block aligned to the right and vertically centered in header */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-end;
        text-align: right;
        white-space: pre;
        gap: 4px; /* Consistent 8px rhythm */
        font-size: 13px; /* Slightly smaller for hierarchy */
        color: #e0e0e0; /* Enhanced contrast */
      }
      .cli-status > div {
        line-height: 1.2;
        margin: 0;
        padding: 0;
      }
      /* Center the round indicator in the header on wide viewports. It is positioned
         absolutely so it visually sits in the header center while the status block
         remains right-aligned. On narrow screens we fall back to the normal flow. */
      #cli-round {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        pointer-events: none; /* keep header controls usable underneath if present */
      }
      #cli-help {
        margin: 0;
        padding-left: 16px;
      }
      .cli-footer {
        margin-top: auto;
        border-top: 1px solid #3a3a3a;
      }
      #cli-controls-hint {
        position: relative;
        z-index: 2;
        padding: 8px 16px; /* Consistent spacing */
        font-size: 12px;
        text-align: center;
        background: #0b0c0c;
        color: #cccccc; /* Enhanced contrast */
        opacity: 0.9;
        border-top: 1px solid #222; /* Subtle separation */
        font-family: inherit;
      }
      #cli-controls-hint:before {
        content: "│ "; /* Terminal-style separator */
        opacity: 0.6;
      }
      /* Enhanced CLI prompt styling */
      #cli-prompt {
        padding: 8px 16px;
        font-family: inherit;
        color: #9ad1ff;
        background: #111;
        border-top: 1px solid #333;
        font-weight: 500;
      }
      #cli-cursor {
        color: #9ad1ff;
        font-weight: bold;
      }
      /* Terminal-style snackbar line at the bottom */
      #snackbar-container {
        padding: 8px 12px;
        background: #111;
        color: #e6e6e6;
      }
      #snackbar-container .snackbar {
        display: block;
      }
      /* Shortcuts/help panel: make it a collapsible, in-flow block like `.cli-settings`.
         Visibility is controlled via the `hidden` attribute so tests and scripts can toggle it.
         Keep a modest max-width for readability and stack nicely on small screens. */
      #cli-shortcuts {
        position: static; /* participate in normal flow */
        margin: 0; /* align with other .cli-block sections */
        background: transparent; /* `.cli-block` provides visible background/border */
        max-width: 760px;
        width: 100%;
      }
      #cli-shortcuts-close {
        /* place the close control inline and visually aligned to the right */
        float: none;
        background: none;
        border: 0;
        color: #f2f2f2;
        cursor: pointer;
        font-size: 16px;
        display: inline-block;
        margin-left: auto;
      }
      /* Ensure good contrast for links if any appear */
      a {
        color: #9ad1ff;
      }
      a:focus,
      button:focus,
      input:focus,
      select:focus,
      [tabindex]:focus {
        /* Enhanced, high-visibility focus indicator */
        outline: 3px solid #9ad1ff;
        outline-offset: 2px;
        /* Add a subtle ring to improve contrast separation on dark bg */
        box-shadow:
          0 0 0 2px #0b0c0c,
          0 0 0 4px #9ad1ff;
      }
      .skip-link {
        position: absolute;
        top: -40px;
        left: 0;
        background: #0b0c0c;
        color: #f2f2f2;
        padding: 8px;
      }
      .skip-link:focus {
        top: 0;
      }
      #start-match-button {
        background: transparent;
        border: 1px solid #9ad1ff;
        color: #9ad1ff;
        padding: 8px 12px;
        font-family: inherit;
        cursor: pointer;
        font-size: 1em;
      }

      #start-match-button:hover,
      #start-match-button:focus {
        background: #1a1a1a;
        outline: 2px solid #9ad1ff;
        outline-offset: 2px;
      }

      /* Responsive tweaks: improve header wrapping and control spacing on narrow screens */
      @media (max-width: 720px) {
        .cli-header {
          flex-direction: column;
          align-items: stretch;
          height: auto;
          gap: 8px;
          padding: 12px; /* Consistent with enhanced padding */
        }
        .cli-title {
          margin-bottom: 4px;
          font-size: 14px; /* Slightly smaller for mobile */
        }
        .cli-controls {
          flex-wrap: wrap;
          gap: 6px;
          align-items: center;
        }
        .cli-controls label {
          min-width: 6ch;
          font-size: 12px; /* Consistent sizing */
        }
        .cli-status {
          flex-direction: row;
          align-items: center;
          justify-content: space-between;
          gap: 12px;
          margin-top: 4px;
        }
        .cli-status > div {
          font-size: 12px; /* Consistent sizing */
          line-height: 1.2;
        }
        .cli-main {
          padding: 12px; /* Consistent 8px rhythm */
        }
        #cli-stats {
          grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
          min-height: 8rem; /* Maintain reservation on mobile */
        }
        .ascii-sep {
          font-size: 11px; /* Smaller separators on mobile */
          letter-spacing: 1px;
        }
        /* Disable absolute centering on narrow screens so the round indicator
           participates in normal flow and avoids overlap with stacked header items. */
        #cli-round {
          position: static;
          transform: none;
          left: auto;
          top: auto;
          pointer-events: auto;
        }
      }

      @media (max-width: 420px) {
        .cli-controls label {
          display: none; /* keep inputs accessible, hide repetitive labels to save space */
        }
        .cli-controls input,
        .cli-controls select {
          min-width: 5ch;
        }
        #cli-score {
          font-size: 12px;
        }
      }
    </style>
    <script>
      if (
        localStorage.getItem("userFlags") &&
        JSON.parse(localStorage.getItem("userFlags")).cliImmersive
      ) {
        document.body.classList.add("cli-immersive");
      }
      if (
        localStorage.getItem("userFlags") &&
        JSON.parse(localStorage.getItem("userFlags")).scanlines
      ) {
        document.body.classList.add("scanlines");
      }
    </script>
  </head>
  <body class="cli-retro cli-immersive">
    <div class="terminal-title-bar">bash — JU-DO-KON</div>
    <a href="#cli-main" class="skip-link">Skip to main content</a>
    <div id="cli-root" class="cli-root" data-round="0" data-target="0" data-test="cli-root">
      <header id="cli-header" class="cli-header" role="banner">
        <div class="cli-title">
          <a href="../../index.html" data-testid="home-link" aria-label="Return to home">Home</a>
          &nbsp;|&nbsp; Classic Battle (CLI)
          <span
            id="battle-state-badge"
            data-flag="battleStateBadge"
            class="state-badge"
            aria-live="polite"
            style="display: none"
            >State: —</span
          >
        </div>
        <!-- header title + status only; controls moved into main.settings for less prominence -->
        <div class="cli-status" aria-live="polite" aria-atomic="true">
          <div id="cli-round">Round 0 of 0</div>
          <div id="cli-score" data-score-player="0" data-score-opponent="0" data-test="cli-score">
            You: 0 Opponent: 0
          </div>
        </div>
      </header>

      <main id="cli-main" class="cli-main" role="main">
        <section aria-label="Round Status" class="cli-block">
          <div id="round-message" role="status" aria-live="polite" aria-atomic="true"></div>
          <div id="cli-countdown" role="status" aria-live="polite" data-remaining-time="0"></div>
        </section>
        <div class="ascii-sep">────────────────────────</div>

        <!-- Less-prominent settings section moved into main to reduce header prominence -->
        <section aria-label="Match Settings" class="cli-block cli-settings">
          <div
            class="cli-settings-header"
            style="display: flex; align-items: center; justify-content: space-between"
          >
            <div style="font-weight: 600">Match Settings</div>
            <div>
              <button
                id="cli-settings-toggle"
                aria-expanded="true"
                aria-controls="cli-settings-body"
                style="
                  background: transparent;
                  border: 0;
                  color: inherit;
                  cursor: pointer;
                  font-family: inherit;
                "
              >
                Settings ▾
              </button>
            </div>
          </div>
          <div id="cli-settings-body">
            <div class="cli-settings-row">
              <label for="points-select">Win target:</label>
              <select
                id="points-select"
                aria-label="Points to win"
                data-tooltip-id="settings.pointsToWin"
              >
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="15">15</option>
              </select>
            </div>
            <div class="cli-settings-row">
              <label for="verbose-toggle">Verbose:</label>
              <input
                id="verbose-toggle"
                type="checkbox"
                aria-label="Toggle verbose logging"
                data-flag="cliVerbose"
              />
            </div>
            <div class="cli-settings-row">
              <label for="seed-input">Seed:</label>
              <div style="display: flex; flex-direction: column">
                <input
                  id="seed-input"
                  type="number"
                  inputmode="numeric"
                  aria-label="Deterministic seed (optional)"
                  style="width: 6ch"
                />
                <div id="seed-error" style="color: #f88; font-size: 12px"></div>
              </div>
            </div>
          </div>
        </section>
        <div class="ascii-sep">────────────────────────</div>

        <section aria-label="Stat Selection" class="cli-block">
          <div
            id="cli-stats"
            role="listbox"
            tabindex="0"
            aria-label="Select a stat with number keys 1–5"
          >
            <!-- Skeleton placeholders to stabilize layout and tests -->
            <div class="cli-stat skeleton">(1) ─────────────── ─</div>
            <div class="cli-stat skeleton">(2) ─────────────── ─</div>
            <div class="cli-stat skeleton">(3) ─────────────── ─</div>
            <div class="cli-stat skeleton">(4) ─────────────── ─</div>
            <div class="cli-stat skeleton">(5) ─────────────── ─</div>
          </div>
        </section>
        <div class="ascii-sep">────────────────────────</div>

        <section
          aria-label="Shortcuts"
          id="cli-shortcuts"
          class="cli-block cli-settings"
          data-flag="cliShortcuts"
          hidden
        >
          <div
            class="cli-settings-header"
            style="display: flex; align-items: center; justify-content: space-between"
          >
            <div style="font-weight: 600">Shortcuts</div>
            <div>
              <button
                id="cli-shortcuts-close"
                aria-label="Close help"
                aria-controls="cli-shortcuts-body"
                aria-expanded="false"
                style="
                  background: transparent;
                  border: 0;
                  color: inherit;
                  cursor: pointer;
                  font-family: inherit;
                "
              >
                ×
              </button>
            </div>
          </div>
          <div id="cli-shortcuts-body">
            <ul id="cli-help">
              <li>[1-5] Select Stat</li>
              <li>[↵]/[Space] Next</li>
              <li>[Q] Quit</li>
              <li>[H] Toggle Help</li>
            </ul>
          </div>
        </section>
        <div class="ascii-sep">────────────────────────</div>

        <section
          aria-label="Verbose Log"
          id="cli-verbose-section"
          class="cli-block"
          data-flag="cliVerbose"
          hidden
        >
          <pre
            id="cli-verbose-log"
            aria-live="polite"
            aria-atomic="false"
            style="margin: 0; white-space: pre-wrap"
          ></pre>
        </section>
        <div id="cli-prompt" role="textbox" aria-label="Command prompt">
          &gt; <span id="cli-cursor" aria-hidden="true">▌</span>
        </div>
      </main>

      <footer class="cli-footer" role="contentinfo">
        <div id="cli-controls-hint" aria-hidden="true">
          [1-5] Stats │ [↵/Space] Next │ [H] Help │ [Q] Quit
        </div>
        <!-- Terminal-style snackbar container anchored at the bottom -->
        <div id="snackbar-container">
          <!-- snackbar.js will populate .snackbar elements here; in CLI this renders as a single bottom line. -->
        </div>
      </footer>
      <!-- Hidden containers for compatibility with classic battle DOM queries -->
      <div id="player-card" style="display: none"></div>
      <div id="opponent-card" style="display: none"></div>
      <div id="modal-container"></div>
      <script type="module" src="../pages/battleCLI.init.js"></script>
      <script type="module" src="../pages/battleCLI.js"></script>
    </div>
  </body>
</html>
