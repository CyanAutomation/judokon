[
  {
    "id": 1,
    "name": "waitingForMatchStart",
    "type": "initial",
    "description": "Idle state before the match begins. UI shows Start/Ready and win target selection (5, 10, or 15).",
    "onEnter": ["render:matchLobby", "reset:scoresAndUI"],
    "triggers": [
      { "on": "startClicked", "target": "matchStart" },
      {
        "on": "interrupt",
        "target": "waitingForMatchStart",
        "note": "No active match to abort; remain in lobby."
      }
    ]
  },
  {
    "id": 2,
    "name": "matchStart",
    "description": "Initialises match context. Stores selected win target, resets scores, and fixes user as first player for all rounds.",
    "onEnter": [
      "init:matchContext",
      "store:winTargetSelection",
      "reset:scores",
      "set:firstPlayerUser"
    ],
    "triggers": [
      { "on": "ready", "target": "cooldown" },
      { "on": "interrupt", "target": "interruptMatch" },
      { "on": "error", "target": "interruptMatch" }
    ]
  },
  {
    "id": 7,
    "name": "cooldown",
    "description": "Short pacing pause before the first round and between rounds; allows animations and readability.",
    "onEnter": ["timer:startShortCountdown", "announce:nextRoundInUI"],
    "triggers": [
      { "on": "ready", "target": "roundStart" },
      { "on": "interrupt", "target": "interruptRound" }
    ]
  },
  {
    "id": 3,
    "name": "roundStart",
    "description": "Begins a new round. Randomly draws judoka for user and opponent, reveals both, user is the active chooser.",
    "onEnter": ["draw:randomJudokaBothSides", "reveal:roundCards", "set:activePlayerUser"],
    "triggers": [
      { "on": "cardsRevealed", "target": "waitingForPlayerAction" },
      { "on": "interrupt", "target": "interruptRound" }
    ]
  },
  {
    "id": 4,
    "name": "waitingForPlayerAction",
    "description": "Awaiting the user's stat choice. If no action within the round timer, optional auto-select may fire.",
    "onEnter": ["prompt:chooseStat", "timer:startStatSelection", "a11y:exposeTimerStatus"],
    "triggers": [
      { "on": "statSelected", "target": "roundDecision" },
      {
        "on": "timeout",
        "target": "roundDecision",
        "guard": "autoSelectEnabled",
        "note": "If FF_AUTO_SELECT is ON, engine auto-picks a stat on timeout."
      },
      {
        "on": "timeout",
        "target": "interruptRound",
        "guard": "!autoSelectEnabled",
        "note": "If FF_AUTO_SELECT is OFF, treat timeout as an interrupt path."
      },
      { "on": "interrupt", "target": "interruptRound" }
    ]
  },
  {
    "id": 5,
    "name": "roundDecision",
    "description": "Compares the selected stat and determines the round outcome.",
    "onEnter": ["compare:selectedStat", "compute:roundOutcome", "announce:roundOutcome"],
    "triggers": [
      { "on": "evaluate", "target": "processingRound" },
      { "on": "interrupt", "target": "interruptRound" }
    ]
  },
  {
    "id": 100,
    "name": "processingRound",
    "description": "Processes the round outcome and transitions to the round over state.",
    "onEnter": [],
    "triggers": [
      { "on": "outcome=winP1", "target": "roundOver" },
      { "on": "outcome=winP2", "target": "roundOver" },
      { "on": "outcome=draw", "target": "roundOver" },
      { "on": "interrupt", "target": "interruptRound" }
    ]
  },
  {
    "id": 6,
    "name": "roundOver",
    "description": "Updates scores and presents a brief summary. No card transfers occur.",
    "onEnter": ["update:score", "update:UIRoundSummary"],
    "triggers": [
      {
        "on": "matchPointReached",
        "target": "matchDecision",
        "guard": "scoreP1 >= winTarget || scoreP2 >= winTarget",
        "note": "Checks the user-selected win target (5/10/15)."
      },
      { "on": "continue", "target": "cooldown" },
      { "on": "interrupt", "target": "interruptRound" }
    ]
  },
  {
    "id": 8,
    "name": "matchDecision",
    "description": "Determines the overall winner once a player reaches the selected win target.",
    "onEnter": ["compute:matchOutcome", "render:matchSummary"],
    "triggers": [
      { "on": "finalize", "target": "matchOver" },
      { "on": "interrupt", "target": "interruptMatch" }
    ]
  },
  {
    "id": 9,
    "name": "matchOver",
    "type": "final",
    "description": "Match completed. Offer Rematch or Home. Final score remains visible.",
    "onEnter": ["show:matchResultScreen"],
    "triggers": [
      { "on": "rematch", "target": "waitingForMatchStart" },
      { "on": "home", "target": "waitingForMatchStart" }
    ]
  },
  {
    "id": 98,
    "name": "interruptRound",
    "description": "Round-level interruption (quit, navigation, or error). Performs safe rollback and offers options.",
    "onEnter": [
      "timer:clearIfRunning",
      "rollback:roundContextIfNeeded",
      "log:analyticsInterruptRound"
    ],
    "triggers": [
      { "on": "roundModifyFlag", "target": "roundModification", "guard": "FF_ROUND_MODIFY" },
      { "on": "restartRound", "target": "cooldown" },
      { "on": "resumeLobby", "target": "waitingForMatchStart" },
      { "on": "abortMatch", "target": "matchOver" }
    ]
  },
  {
    "id": 97,
    "name": "roundModification",
    "description": "Admin/test-only branch to adjust round decision parameters before re-evaluating.",
    "onEnter": ["open:roundModificationPanel"],
    "triggers": [
      { "on": "modifyRoundDecision", "target": "roundDecision" },
      { "on": "cancelModification", "target": "interruptRound" }
    ]
  },
  {
    "id": 99,
    "name": "interruptMatch",
    "description": "Match-level interruption from setup or critical error. Cleans up context and returns to lobby on request.",
    "onEnter": ["timer:clearIfRunning", "teardown:matchContext", "log:analyticsInterruptMatch"],
    "triggers": [
      { "on": "restartMatch", "target": "matchStart" },
      { "on": "toLobby", "target": "waitingForMatchStart" }
    ]
  }
]
