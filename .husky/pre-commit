#!/bin/sh
# Husky pre-commit: run JSDoc + @pseudocode checker + RAG reminder for agents
# To bypass locally: SKIP_CHECK_JSDOC=1 git commit -m "..."

# ğŸš¨ Agent Reminder
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘ ğŸ¤– AGENT REMINDER: RAG-FIRST POLICY                                    â•‘"
echo "â•‘ Before using grep/ripgrep/semantic_search, query RAG first!            â•‘"
echo "â•‘ See AGENTS.md â†’ ğŸš¨ RAG-First Policy section for details               â•‘"
echo "â•‘ Expected benefit: ~15x faster than manual exploration                  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

SKIP_VAR_NAME=SKIP_CHECK_JSDOC
# POSIX-safe indirect expansion: evaluate the named var's value
SKIP_VAL=$(eval "echo \$$SKIP_VAR_NAME")
if [ "$SKIP_VAL" = "1" ]; then
  echo "Skipping JSDoc check because ${SKIP_VAR_NAME}=1"
else
  echo "Running JSDoc/pseudocode check..."
  set +e
  npm run check:jsdoc
  status=$?
  set -e
  if [ $status -ne 0 ]; then
    printf "\nJSDoc check failed (non-blocking). To bypass set %s=1 and retry commit.\n" "$SKIP_VAR_NAME"
    echo "Run 'npm run check:jsdoc' to see details. This hook will not block commits."
  else
    echo "JSDoc check passed"
  fi
fi

echo "Running PRD Test Coverage link check..."
if ! npm run check:prd-test-links; then
  echo "PRD Test Coverage link check failed. Fix dead links before commit."
  exit 1
fi

exit 0
