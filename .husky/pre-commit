#!/bin/sh
# Husky pre-commit: run JSDoc + @pseudocode checker + RAG reminder for agents
# To bypass locally: SKIP_CHECK_JSDOC=1 git commit -m "..."

# ðŸš¨ Agent Reminder
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘ ðŸ¤– AGENT REMINDER: RAG-FIRST POLICY                                    â•‘"
echo "â•‘ Before using grep/ripgrep/semantic_search, query RAG first!            â•‘"
echo "â•‘ See AGENTS.md â†’ ðŸš¨ RAG-First Policy section for details               â•‘"
echo "â•‘ Expected benefit: ~15x faster than manual exploration                  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

SKIP_VAR_NAME=SKIP_CHECK_JSDOC
# POSIX-safe indirect expansion: evaluate the named var's value
SKIP_VAL=$(eval "echo \$SKIP_VAR_NAME")
if [ "$SKIP_VAL" = "1" ]; then
  echo "Skipping JSDoc check because ${SKIP_VAR_NAME}=1"
  exit 0
fi

echo "Running JSDoc/pseudocode check..."
set +e
npm run check:jsdoc
status=$?
set -e
if [ $status -ne 0 ]; then
  printf "\nJSDoc check failed (non-blocking). To bypass set %s=1 and retry commit.\n" "$SKIP_VAR_NAME"
  echo "Run 'npm run check:jsdoc' to see details. This hook will not block commits." 
else
  echo "JSDoc check passed"
fi

# RAG Model Check and Auto-Repair
echo "Running RAG model file check..."

# Pre-flight: Clean any corrupted Xenova cache to prevent stale stub files
# This ensures transformers downloads fresh files on the next prep
echo "  Pre-flight: Checking for corrupted Xenova cache..."
if [ -d "models/Xenova/all-MiniLM-L6-v2" ]; then
  # Quick size check: if any file is suspiciously small, clean the cache
  onnx_size=$(stat -f%z "models/Xenova/all-MiniLM-L6-v2/onnx/model_quantized.onnx" 2>/dev/null || stat -c%s "models/Xenova/all-MiniLM-L6-v2/onnx/model_quantized.onnx" 2>/dev/null || echo "0")
  if [ "$onnx_size" -lt 1000000 ] && [ "$onnx_size" -gt 0 ]; then
    echo "    Detected corrupted Xenova cache (stub files), removing for clean re-download..."
    rm -rf models/Xenova/all-MiniLM-L6-v2 || true
  fi
fi

set +e
npm run check:rag
rag_status=$?
set -e
if [ $rag_status -ne 0 ]; then
  printf "\nRAG model files corrupted or missing. Attempting auto-repair...\n"
  set +e
  npm run rag:prepare:models -- --force
  repair_status=$?
  set -e
  if [ $repair_status -eq 0 ]; then
    echo "âœ… RAG model files repaired successfully"
  else
    printf "\nWARNING: Auto-repair failed. Please run 'npm run rag:prepare:models -- --force' manually.\n"
    echo "This hook will not block commits."
  fi
else
  echo "âœ… RAG model check passed"
fi

exit 0

