# Playwright Quality Patterns Check Workflow
# This workflow validates that Playwright test files follow best practices
# and avoid common anti-patterns. It checks for banned patterns like
# waitForTimeout, setTimeout, innerHTML manipulation, and synthetic events.
# Violations are reported with fix suggestions to improve test quality.
name: Check Playwright Patterns

on:
  pull_request: {}
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: playwright-patterns-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-patterns:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      NODE_VERSION: 22
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run Playwright pattern checker
        id: pattern-check
        run: |
          node scripts/check-playwright-patterns.js --json > playwright-patterns-report.json || echo "PATTERNS_FAILED=true" >> $GITHUB_ENV
          cat playwright-patterns-report.json

      - name: Upload pattern report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-patterns-report
          path: playwright-patterns-report.json
          retention-days: 30

      - name: Check for violations
        if: always()
        run: |
          if [ "$PATTERNS_FAILED" = "true" ]; then
            echo "âŒ Playwright pattern violations found!"
            echo "See the report artifact for details."
            exit 1
          else
            echo "âœ… No Playwright pattern violations found!"
          fi

      - name: Comment on PR (if violations found)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('playwright-patterns-report.json', 'utf8'));

            let comment = '## âš ï¸ Playwright Pattern Violations Found\\n\\n';
            comment += `**Summary:** ${report.summary.errors} errors, ${report.summary.warnings} warnings in ${report.summary.filesChecked} files\\n\\n`;

            if (report.violations.length > 0) {
              comment += '### Violations\\n\\n';
              report.violations.slice(0, 5).forEach(file => {
                comment += `**${file.file}:**\\n`;
                file.violations.forEach(v => {
                  const icon = v.severity === 'error' ? 'ðŸš«' : 'âš ï¸';
                  comment += `- ${icon} \`${v.pattern}\`: ${v.description}\\n`;
                  comment += `  - Lines: ${v.lines.join(', ')}\\n`;
                  if (v.fixSuggestion) {
                    comment += `  - ðŸ’¡ Fix: ${v.fixSuggestion}\\n`;
                  }
                });
                comment += '\\n';
              });
              
              if (report.violations.length > 5) {
                comment += `\\n*... and ${report.violations.length - 5} more files with violations*\\n`;
              }
            }

            comment += '\\n---\\n';
            comment += '*To ignore a specific violation, add `// playwright-patterns: ignore-next-line` before the line.*\\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
