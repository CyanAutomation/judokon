# Workflow Name: Update Vector Database
# Purpose: Nightly refresh of vector embeddings and offline RAG assets
#
# This workflow:
#   - Regenerates vector embeddings from documentation sources
#   - Builds offline RAG artifacts from fresh embeddings
#   - Validates all generated files exist and are well-formed
#   - Creates PR with embedding updates and offline assets
#   - Tracks embedding statistics and vector metadata
#   - Provides detailed diff and metrics on PR body
#
# Trigger Events:
#   1. Scheduled: Daily at 3:15 AM UTC (after lintAutofix.yml, before rag_validation.yml)
#   2. Manual: Can be triggered via GitHub Actions interface
#
# Files Modified:
#   - src/data/client_embeddings.json (vector embeddings)
#   - src/data/client_embeddings.meta.json (embedding metadata)
#   - src/data/offline_rag_vectors.bin (offline RAG binary)
#   - src/data/offline_rag_metadata.json (offline RAG metadata)
#
# Performance:
#   - Node.js 22 LTS (aligned with other workflows)
#   - Memory: 8GB heap for embedding generation
#   - npm cache for fast dependency installation
#   - Expected duration: ~15-20 minutes
#
# Workflow Sequence (UTC):
#   - 03:00: lintAutofix.yml (auto-format, lint fixes)
#   - 03:15: updateEmbeddings.yml (THIS WORKFLOW - vector embeddings)
#   - 04:00: rag_validation.yml (validate RAG system)
#   - 08:00: runUnitTests.yml (on push/PR only)

name: Update Vector Database

on:
  schedule:
    - cron: "15 3 * * *" # Runs daily at 03:15 UTC (1 hour 15 min after lintAutofix)
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  checks: write

concurrency:
  group: update-embeddings
  cancel-in-progress: true

jobs:
  generate_embeddings:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      NODE_OPTIONS: --max-old-space-size=8192

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 22
        uses: actions/setup-node@v4
        id: setup-node
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate configuration
        id: validate
        timeout-minutes: 2
        run: |
          echo "‚úì Checking required scripts..."
          [ -f "scripts/generateEmbeddings.js" ] || { echo "‚ùå Generator script missing"; exit 1; }
          [ -f "scripts/buildOfflineRag.mjs" ] || { echo "‚ùå Builder script missing"; exit 1; }
          echo "‚úì Checking disk space..."
          df -h | grep -E "/$"
          echo "‚úì All configuration checks passed"

      - name: Prepare local RAG model
        id: prepare-model
        run: npm run rag:prepare:models
        timeout-minutes: 10

      - name: Generate embeddings
        id: generate-embeddings
        run: npm run generate:embeddings
        timeout-minutes: 15

      - name: Validate embeddings generated
        id: validate-embeddings
        run: |
          if [ ! -f "src/data/client_embeddings.json" ]; then
            echo "‚ùå Embeddings file not generated"
            exit 1
          fi
          SIZE=$(wc -c < "src/data/client_embeddings.json")
          SIZE_KB=$((SIZE / 1024))
          echo "‚úì Embeddings file generated: ${SIZE_KB}KB"
          echo "size_kb=${SIZE_KB}" >> $GITHUB_OUTPUT

          # Validate JSON structure - embeddings is a root-level array of embedding objects
          echo "‚úì Validating embeddings JSON structure..."

          # First: Basic JSON validity check
          jq empty src/data/client_embeddings.json > /dev/null 2>&1 || {
            echo "‚ùå Invalid JSON syntax"
            exit 1
          }

          # Second: Check root structure
          ROOT_TYPE=$(jq -r 'type' src/data/client_embeddings.json)
          if [ "$ROOT_TYPE" != "array" ]; then
            echo "‚ùå Root must be a JSON array, got: $ROOT_TYPE"
            exit 1
          fi

          # Third: Check array is non-empty
          ARRAY_LEN=$(jq 'length' src/data/client_embeddings.json)
          if [ "$ARRAY_LEN" -eq 0 ]; then
            echo "‚ùå Array is empty"
            exit 1
          fi

          # Fourth: Validate first and sample items
          FIRST_TYPE=$(jq -r '.[0] | type' src/data/client_embeddings.json)
          if [ "$FIRST_TYPE" != "object" ]; then
            echo "‚ùå First element must be object, got: $FIRST_TYPE"
            exit 1
          fi

          # Fifth: Check required fields on sample of items (first, middle, last)
          jq -e '
            def validate_item:
              (has("id") and has("text") and has("embedding") and has("source")) or
              error("Missing required fields: id, text, embedding, source");
            
            (.[0] | validate_item) and
            (.[length/2 | floor] | validate_item) and
            (.[-1] | validate_item)
          ' src/data/client_embeddings.json > /dev/null || {
            echo "‚ùå Missing required fields (id, text, embedding, source)"
            exit 1
          }

          echo "‚úì Embeddings JSON is valid ($ARRAY_LEN entries)"

      - name: Check if embeddings changed
        id: embeds-check
        shell: bash
        run: |
          # Stage only embedding files to detect drift from this step
          git add src/data/client_embeddings.json src/data/client_embeddings.meta.json 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "Embeddings unchanged. Skipping offline build."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Embeddings changed. Will rebuild offline assets."
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Build offline RAG assets
        id: build-offline
        if: steps.embeds-check.outputs.changed == 'true'
        timeout-minutes: 5
        shell: bash
        run: |
          set -euxo pipefail
          echo "Building offline RAG assets from fresh embeddings..."
          npm run build:offline-rag
          echo "‚úì Offline build complete"
          echo '--- offline artifacts present ---'
          (cd src && find data -maxdepth 1 -type f -name 'offline_rag_*' -print 2>/dev/null || true)

      - name: Validate offline files exist
        id: validate-offline
        if: steps.embeds-check.outputs.changed == 'true'
        shell: bash
        run: |
          err=0
          if [ ! -f "src/data/offline_rag_vectors.bin" ]; then
            echo "‚ùå missing offline_rag_vectors.bin"
            err=1
          else
            VEC_SIZE=$(stat -f%z "src/data/offline_rag_vectors.bin" 2>/dev/null || stat -c%s "src/data/offline_rag_vectors.bin")
            echo "‚úì offline_rag_vectors.bin: $((VEC_SIZE / 1024 / 1024))MB"
          fi

          if [ ! -f "src/data/offline_rag_metadata.json" ]; then
            echo "‚ùå missing offline_rag_metadata.json"
            err=1
          else
            echo "‚úì offline_rag_metadata.json present"
            # Validate JSON structure
            jq '.vectorLength, .count' src/data/offline_rag_metadata.json > /dev/null || {
              echo "‚ùå Invalid offline metadata JSON"
              exit 1
            }
          fi

          if [ $err -ne 0 ]; then
            echo "Hint: verify scripts/buildOfflineRag.mjs writes to src/data/."
            exit 1
          fi
          echo "‚úì All offline files validated"

      - name: Check for changes
        id: git-check
        run: |
          # Stage both embeddings and offline assets so a single PR includes everything
          git add src/data/client_embeddings.json src/data/client_embeddings.meta.json 2>/dev/null || true
          git add src/data/offline_rag_vectors.bin src/data/offline_rag_metadata.json 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected."
            echo "changed=true" >> $GITHUB_OUTPUT
            
            # Count changed files
            COUNT=$(git diff --cached --name-only | wc -l | tr -d ' ')
            echo "files_changed=$COUNT" >> $GITHUB_OUTPUT
          fi

      - name: Monitor system resources
        if: always()
        run: |
          echo "=== Memory Usage ==="
          free -h
          echo ""
          echo "=== Disk Usage ==="
          df -h | grep -E "/$|src"
          echo ""
          echo "=== Data Directory Size ==="
          du -sh src/data/ 2>/dev/null || echo "Cannot calculate"

      - name: Check embedding size changes
        id: size-check
        if: steps.git-check.outputs.changed == 'true'
        run: |
          META_FILE="src/data/client_embeddings.meta.json"
          if [ -f "$META_FILE" ]; then
            SIZE=$(jq '.fileSizeKB' < "$META_FILE")
            if [ "$SIZE" -gt 50000 ]; then
              echo "‚ö†Ô∏è Warning: Embeddings are large (${SIZE}KB). May impact load times."
            else
              echo "‚úì Embedding size within normal range: ${SIZE}KB"
            fi
            echo "size_warning=false" >> $GITHUB_OUTPUT
          fi

      - name: Get current date
        if: steps.git-check.outputs.changed == 'true'
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Fetch Developer Aphorism
        if: steps.git-check.outputs.changed == 'true'
        id: quote
        timeout-minutes: 1
        run: |
          RESPONSE=$(curl -fsL --max-time 5 https://zenquotes.io/api/random 2>/dev/null || true)
          if [ -z "$RESPONSE" ]; then
            echo "quote=Code is poetry. Every commit is an art form. üé®" >> $GITHUB_OUTPUT
          else
            QUOTE=$(echo "$RESPONSE" | jq -r '.[0] | "\(.q) ‚Äî \(.a)"' 2>/dev/null || echo "Code is poetry. üé®")
            echo "quote=$QUOTE" >> $GITHUB_OUTPUT
          fi

      - name: Load Embedding Stats
        if: steps.git-check.outputs.changed == 'true'
        id: stats
        run: |
          META_FILE="src/data/client_embeddings.meta.json"
          if [ -f "$META_FILE" ]; then
            COUNT=$(jq '.count' < "$META_FILE")
            AVG=$(jq '.avgVectorLength' < "$META_FILE")
            SIZE=$(jq '.fileSizeKB' < "$META_FILE")
            echo "summary=üß† Embedding DB: $COUNT entries, avg vector: $AVG, size: ${SIZE}KB" >> $GITHUB_OUTPUT
          else
            echo "summary=Embedding stats unavailable. ‚ùå" >> $GITHUB_OUTPUT
          fi

      - name: Load Offline RAG Summary
        if: steps.git-check.outputs.changed == 'true'
        id: offline
        shell: bash
        run: |
          OUT_DIR="src/data"
          size_kb() {
            if [ -f "$1" ]; then
              echo "$(($(wc -c < "$1")/1024))KB"
            else
              echo "‚Äî"
            fi
          }
          VEC_SZ=$(size_kb "$OUT_DIR/offline_rag_vectors.bin")
          META_SZ=$(size_kb "$OUT_DIR/offline_rag_metadata.json")
          if [ -f "$OUT_DIR/offline_rag_metadata.json" ]; then
            read -r DIM DOCS <<<"$(node -e 'const fs=require("fs");const m=JSON.parse(fs.readFileSync(process.argv[1],"utf8"));process.stdout.write(`${m.vectorLength||"?"} ${m.count||"?"}`);' "$OUT_DIR/offline_rag_metadata.json")"
          else
            DOCS="?"; DIM="?"
          fi
          echo "vec=${VEC_SZ}"   >> $GITHUB_OUTPUT
          echo "meta=${META_SZ}" >> $GITHUB_OUTPUT
          echo "docs=${DOCS}"    >> $GITHUB_OUTPUT
          echo "dim=${DIM}"      >> $GITHUB_OUTPUT

      - name: Generate embedding update report
        if: steps.git-check.outputs.changed == 'true'
        run: |
          {
            echo "### Vector Database Update Report"
            echo ""
            echo "‚úÖ **Status**: Embeddings Updated Successfully"
            echo ""
            echo "**Update Details:**"
            echo "- Embeddings regenerated: ‚úì"
            echo "- Offline RAG assets built: ‚úì"
            echo "- Files validated: ‚úì"
            echo "- Files changed: ${{ steps.git-check.outputs.files_changed }}"
            echo ""
            echo "**Embedding Metrics:**"
            echo "${{ steps.stats.outputs.summary }}"
            echo ""
            echo "**Offline RAG Assets:**"
            echo "- Vector binary: ${{ steps.offline.outputs.vec }}"
            echo "- Metadata: ${{ steps.offline.outputs.meta }}"
            echo "- Documents indexed: ${{ steps.offline.outputs.docs }}"
            echo "- Vector dimensions: ${{ steps.offline.outputs.dim }}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload embedding artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: embeddings-artifacts-${{ github.run_id }}
          path: |
            src/data/client_embeddings.json
            src/data/client_embeddings.meta.json
            src/data/offline_rag_vectors.bin
            src/data/offline_rag_metadata.json
          retention-days: 7
          if-no-files-found: ignore

      - name: Create Pull Request
        if: steps.git-check.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "PR: Update vector database embeddings"
          title: "PR: Updated Vector + Offline RAG - ${{ env.date }}"
          body: |
            ‚úÖ **Embeddings + Offline RAG Updated**
            This PR updates `client_embeddings.json` via the nightly pipeline and refreshes offline RAG artifacts.

            üìê **Embedding Stats**
            ${{ steps.stats.outputs.summary }}

            üì¶ **Offline RAG Summary**
            - Vectors size: ${{ steps.offline.outputs.vec }}
            - Meta size:    ${{ steps.offline.outputs.meta }}
            - Docs:         ${{ steps.offline.outputs.docs }}
            - Dim:          ${{ steps.offline.outputs.dim }}

            üí¨ **Coding Aphorism**
            _${{ steps.quote.outputs.quote }}_

          branch: auto/update-vector-db
          branch-suffix: timestamp
          labels: |
            automated
            backend
            vector
            offline
          assignees: ${{ github.actor }}

      - name: Report success
        if: steps.git-check.outputs.changed == 'true'
        run: |
          {
            echo "### üì¶ Vector Database Updated"
            echo ""
            echo "Pull request created with latest embeddings and offline RAG assets."
            echo "Review: [View PR](https://github.com/${{ github.repository }}/pulls?q=is%3Apr+is%3Aopen+branch%3Aauto%2Fupdate-vector-db)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Report no changes
        if: steps.git-check.outputs.changed == 'false'
        run: |
          {
            echo "### ‚ÑπÔ∏è No Changes Detected"
            echo ""
            echo "Vector database and offline RAG assets are up to date."
            echo "No new PR created."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Report failure
        if: failure()
        run: |
          {
            echo "### ‚ùå Vector Database Update Failed"
            echo ""
            echo "**Common causes:**"
            echo "- Out of memory during embedding generation (check Node memory settings)"
            echo "- RAG model files not downloaded (verify \`rag:prepare:models\`)"
            echo "- Insufficient disk space for offline RAG build"
            echo "- Documentation sources corrupted or missing"
            echo "- Invalid JSON in generated files"
            echo ""
            echo "**Debug info:**"
            echo "- Check system resources section above for memory/disk"
            echo "- Review validation steps for specific errors"
            echo "- Artifacts available for inspection: embeddings-artifacts-${{ github.run_id }}"
          } >> "$GITHUB_STEP_SUMMARY"
