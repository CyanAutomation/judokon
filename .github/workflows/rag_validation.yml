# Workflow Name: RAG Validation
# Purpose: Validate the RAG (Retrieval-Augmented Generation) system integrity
#
# This workflow:
#   - Verifies vector database embeddings are present and valid
#   - Tests RAG query functionality
#   - Ensures model files are correctly downloaded and accessible
#   - Alerts on validation failures
#   - Generates validation reports for visibility
#
# Trigger Events:
#   1. Scheduled: Every day at 4:00 AM UTC (1 hour after lintAutofix)
#   2. Manual: Can be triggered via GitHub Actions interface
#
# Security Note:
#   - Read-only access to repository
#   - Can write workflow summary and artifacts

name: RAG Validation

on:
  schedule:
    - cron: "0 4 * * *" # Runs at 4:00 AM UTC every day (1 hour after lintAutofix)
  workflow_dispatch: {}

permissions:
  contents: read
  checks: write

concurrency:
  group: rag-validation
  cancel-in-progress: true

jobs:
  rag-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Check RAG model files
        id: model-check
        run: npm run check:rag
        continue-on-error: true

      - name: Download RAG models
        id: model-download
        run: npm run rag:prepare:models
        timeout-minutes: 10

      - name: Verify models downloaded
        run: |
          if [ -d "models/minilm" ] && [ "$(ls -A models/minilm)" ]; then
            echo "✅ Model files present"
            ls -lh models/minilm/ | head -5
          else
            echo "⚠️ Model directory missing or empty"
            exit 1
          fi

      - name: Run RAG validation
        id: rag-validation
        run: npm run rag:validate
        timeout-minutes: 5

      - name: Generate validation report
        if: always()
        run: |
          {
            echo "### RAG Validation Report"
            echo ""
            if [ "${{ steps.rag-validation.outcome }}" == "success" ]; then
              echo "✅ **Status**: Validation Passed"
            else
              echo "❌ **Status**: Validation Failed"
            fi
            echo ""
            echo "**Details:**"
            echo "- Model check: ${{ steps.model-check.outcome }}"
            echo "- Model download: ${{ steps.model-download.outcome }}"
            echo "- Validation: ${{ steps.rag-validation.outcome }}"
            echo ""
            echo "**Components:**"
            echo "- ✓ Vector database: Checked"
            echo "- ✓ Model files: Downloaded to \`models/minilm/\`"
            echo "- ✓ Embeddings: Validated"
            echo "- ✓ Query functionality: Tested"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload validation logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: rag-validation-logs
          path: |
            rag_model/
            models/
          retention-days: 7
          if-no-files-found: ignore

      - name: Notify on validation failure
        if: failure()
        run: |
          echo "::error::RAG validation failed. Check model files, embeddings, or query functionality."
          echo "::notice::Review artifact 'rag-validation-logs' for details."
